"use strict";(self.webpackChunkrke_2_docs=self.webpackChunkrke_2_docs||[]).push([[553],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(n),h=r,m=p["".concat(l,".").concat(h)]||p[h]||d[h]||i;return n?a.createElement(m,o(o({ref:t},u),{},{components:n})):a.createElement(m,o({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},5162:function(e,t,n){n.d(t,{Z:function(){return o}});var a=n(7294),r=n(6010),i="tabItem_Ymn6";function o(e){var t=e.children,n=e.hidden,o=e.className;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(i,o),hidden:n},t)}},5488:function(e,t,n){n.d(t,{Z:function(){return h}});var a=n(7462),r=n(7294),i=n(6010),o=n(2389),s=n(7392),l=n(7094),c=n(2466),u="tabList__CuJ",d="tabItem_LNqP";function p(e){var t,n,o=e.lazy,p=e.block,h=e.defaultValue,m=e.values,f=e.groupId,k=e.className,v=r.Children.map(e.children,(function(e){if((0,r.isValidElement)(e)&&"value"in e.props)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),g=null!=m?m:v.map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes}})),y=(0,s.l)(g,(function(e,t){return e.value===t.value}));if(y.length>0)throw new Error('Docusaurus error: Duplicate values "'+y.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var b=null===h?h:null!=(t=null!=h?h:null==(n=v.find((function(e){return e.props.default})))?void 0:n.props.value)?t:v[0].props.value;if(null!==b&&!g.some((function(e){return e.value===b})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+b+'" but none of its children has the corresponding value. Available values are: '+g.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var N=(0,l.U)(),w=N.tabGroupChoices,C=N.setTabGroupChoices,T=(0,r.useState)(b),S=T[0],E=T[1],I=[],K=(0,c.o5)().blockElementScrollPositionUntilNextRender;if(null!=f){var R=w[f];null!=R&&R!==S&&g.some((function(e){return e.value===R}))&&E(R)}var x=function(e){var t=e.currentTarget,n=I.indexOf(t),a=g[n].value;a!==S&&(K(t),E(a),null!=f&&C(f,String(a)))},P=function(e){var t,n=null;switch(e.key){case"ArrowRight":var a,r=I.indexOf(e.currentTarget)+1;n=null!=(a=I[r])?a:I[0];break;case"ArrowLeft":var i,o=I.indexOf(e.currentTarget)-1;n=null!=(i=I[o])?i:I[I.length-1]}null==(t=n)||t.focus()};return r.createElement("div",{className:(0,i.Z)("tabs-container",u)},r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":p},k)},g.map((function(e){var t=e.value,n=e.label,o=e.attributes;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:S===t?0:-1,"aria-selected":S===t,key:t,ref:function(e){return I.push(e)},onKeyDown:P,onFocus:x,onClick:x},o,{className:(0,i.Z)("tabs__item",d,null==o?void 0:o.className,{"tabs__item--active":S===t})}),null!=n?n:t)}))),o?(0,r.cloneElement)(v.filter((function(e){return e.props.value===S}))[0],{className:"margin-top--md"}):r.createElement("div",{className:"margin-top--md"},v.map((function(e,t){return(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==S})}))))}function h(e){var t=(0,o.Z)();return r.createElement(p,(0,a.Z)({key:String(t)},e))}},4332:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return u},default:function(){return f},frontMatter:function(){return c},metadata:function(){return d},toc:function(){return h}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),o=n(5488),s=n(5162),l=["components"],c={title:"CIS Hardening Guide"},u=void 0,d={unversionedId:"security/hardening_guide",id:"security/hardening_guide",title:"CIS Hardening Guide",description:"This document provides prescriptive guidance for hardening a production installation of RKE2. It outlines the configurations and controls required to address Kubernetes benchmark controls from the Center for Internet Security (CIS).",source:"@site/docs/security/hardening_guide.md",sourceDirName:"security",slug:"/security/hardening_guide",permalink:"/security/hardening_guide",draft:!1,editUrl:"https://github.com/rancher/rke2-docs/edit/main/docs/security/hardening_guide.md",tags:[],version:"current",lastUpdatedAt:1669155923,formattedLastUpdatedAt:"11/22/2022",frontMatter:{title:"CIS Hardening Guide"},sidebar:"mySidebar",previous:{title:"About Hardened Images",permalink:"/security/about_hardened_images"},next:{title:"CIS 1.6 Self-Assessment Guide",permalink:"/security/cis_self_assessment16"}},p={},h=[{value:"Host-level requirements",id:"host-level-requirements",level:2},{value:"Ensure <code>protect-kernel-defaults</code> is set",id:"ensure-protect-kernel-defaults-is-set",level:3},{value:"Ensure etcd is configured properly",id:"ensure-etcd-is-configured-properly",level:3},{value:"Setting up hosts",id:"setting-up-hosts",level:3},{value:"Set kernel parameters",id:"set-kernel-parameters",level:4},{value:"Create the etcd user",id:"create-the-etcd-user",level:4},{value:"Kubernetes runtime requirements",id:"kubernetes-runtime-requirements",level:2},{value:"<code>PodSecurityPolicies</code>",id:"podsecuritypolicies",level:3},{value:"<code>NetworkPolicies</code>",id:"networkpolicies",level:3},{value:"Configure <code>default</code> service account",id:"configure-default-service-account",level:3},{value:"API Server audit configuration",id:"api-server-audit-configuration",level:3},{value:"Known issues",id:"known-issues",level:2},{value:"Control  1.1.12",id:"control--1112",level:3},{value:"Control 5.1.5",id:"control-515",level:3},{value:"Control 5.3.2",id:"control-532",level:3},{value:"RKE2 configuration",id:"rke2-configuration",level:2},{value:"Conclusion",id:"conclusion",level:2}],m={toc:h};function f(e){var t=e.components,n=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"This document provides prescriptive guidance for hardening a production installation of RKE2. It outlines the configurations and controls required to address Kubernetes benchmark controls from the Center for Internet Security (CIS)."),(0,i.kt)("p",null,"For more details about evaluating a hardened cluster against the official CIS benchmark, refer to the CIS Benchmark ",(0,i.kt)("a",{parentName:"p",href:"/security/cis_self_assessment123"},"Self-Assessment Guide v1.23"),", or ",(0,i.kt)("a",{parentName:"p",href:"/security/cis_self_assessment16"},"Self-Assessment Guide v1.6")," for RKE2 versions prior to v1.25."),(0,i.kt)("p",null,'RKE2 is designed to be "hardened by default" and pass the majority of the Kubernetes CIS controls without modification. There are a few notable exceptions to this that require manual intervention to fully pass the CIS Benchmark:'),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"RKE2 will not modify the host operating system. Therefore, you, the operator, must make a few host-level modifications."),(0,i.kt)("li",{parentName:"ol"},"Certain CIS controls for Network Policies and Pod Security Standards (or Pod Security Policies (PSP) on RKE2 versions prior to v1.25) will restrict the functionality of the cluster. You must opt into having RKE2 configure these for you.")),(0,i.kt)("p",null,"To help ensure these above requirements are met, RKE2 can be started with the ",(0,i.kt)("inlineCode",{parentName:"p"},"profile")," flag set to ",(0,i.kt)("inlineCode",{parentName:"p"},"cis-1.23"),", or ",(0,i.kt)("inlineCode",{parentName:"p"},"cis-1.6"),". This flag generally does the following:"),(0,i.kt)(o.Z,{mdxType:"Tabs"},(0,i.kt)(s.Z,{value:"v1.25 and Newer",default:!0,mdxType:"TabItem"},(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Checks that host-level requirements have been met. If they haven't, RKE2 will exit with a fatal error describing the unmet requirements.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Configures Pod Security Standards of restricted mode to the whole cluster with exception of the kube-system namespace to allow system pods to run without restrictions, for more information about the pod security standards please refer to the ",(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/security/pod-security-standards/"},"official documentation"),".")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Apply network policies that allow the cluster to pass associated controls."))),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The only valid value for the profile flag is ",(0,i.kt)("inlineCode",{parentName:"p"},"cis-1.23"),". It accepts a string value to allow for other profiles in the future.")))),(0,i.kt)(s.Z,{value:"v1.24 and Older",mdxType:"TabItem"},(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Checks that host-level requirements have been met. If they haven't, RKE2 will exit with a fatal error describing the unmet requirements."),(0,i.kt)("li",{parentName:"ol"},"Configures runtime pod security policies and network policies that allow the cluster to pass associated controls.")),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The only valid values for the profile flag are ",(0,i.kt)("inlineCode",{parentName:"p"},"cis-1.5")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"cis-1.6"),"."))),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The self-assessment guide for CIS v1.5 (",(0,i.kt)("inlineCode",{parentName:"p"},"cis-1.5"),") was removed from this documentation, since this version is applicable only to Kubernetes v1.15 that is not supported anymore. The profile, however, is still available in RKE2."))))),(0,i.kt)("p",null,"The following section outlines the specific actions that are taken when the ",(0,i.kt)("inlineCode",{parentName:"p"},"profile")," flag is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"cis-1.6")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"cis-1.23"),"."),(0,i.kt)("h2",{id:"host-level-requirements"},"Host-level requirements"),(0,i.kt)("p",null,"There are two areas of host-level requirements: kernel parameters and etcd process/directory configuration. These are outlined in this section."),(0,i.kt)("h3",{id:"ensure-protect-kernel-defaults-is-set"},"Ensure ",(0,i.kt)("inlineCode",{parentName:"h3"},"protect-kernel-defaults")," is set"),(0,i.kt)("p",null,"This is a kubelet flag that will cause the kubelet to exit if the required kernel parameters are unset or are set to values that are different from the kubelet's defaults."),(0,i.kt)("p",null,"When the ",(0,i.kt)("inlineCode",{parentName:"p"},"profile")," flag is set, RKE2 will set the flag to ",(0,i.kt)("inlineCode",{parentName:"p"},"true"),"."),(0,i.kt)("p",null,"!!! note\n",(0,i.kt)("inlineCode",{parentName:"p"},"protect-kernel-defaults")," is exposed as a top-level flag for RKE2. If you have set ",(0,i.kt)("inlineCode",{parentName:"p"},"profile"),' to "cis-1.x" and ',(0,i.kt)("inlineCode",{parentName:"p"},"protect-kernel-defaults")," to false explicitly, RKE2 will exit with an error."),(0,i.kt)("p",null,"RKE2 will also check the same kernel parameters that the kubelet does and exit with an error following the same rules as the kubelet. This is done as a convenience to help the operator more quickly and easily identify what kernel parameters are violating the kubelet defaults."),(0,i.kt)("h3",{id:"ensure-etcd-is-configured-properly"},"Ensure etcd is configured properly"),(0,i.kt)("p",null,"The CIS Benchmark requires that the etcd data directory be owned by the ",(0,i.kt)("inlineCode",{parentName:"p"},"etcd")," user and group. This implicitly requires the etcd process run as the host-level ",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),' user. To achieve this, RKE2 takes several steps when started with a valid "cis-1.x" profile:'),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Check that the ",(0,i.kt)("inlineCode",{parentName:"li"},"etcd")," user and group exists on the host. If they don't, exit with an error."),(0,i.kt)("li",{parentName:"ol"},"Create etcd's data directory with ",(0,i.kt)("inlineCode",{parentName:"li"},"etcd")," as the user and group owner."),(0,i.kt)("li",{parentName:"ol"},"Ensure the etcd process is run as the ",(0,i.kt)("inlineCode",{parentName:"li"},"etcd")," user and group by setting the etcd static pod's ",(0,i.kt)("inlineCode",{parentName:"li"},"SecurityContext")," appropriately.")),(0,i.kt)("h3",{id:"setting-up-hosts"},"Setting up hosts"),(0,i.kt)("p",null,"This section gives you the commands necessary to configure your host to meet the above requirements."),(0,i.kt)("h4",{id:"set-kernel-parameters"},"Set kernel parameters"),(0,i.kt)("p",null,"When RKE2 is installed, it creates a sysctl config file to set the required parameters appropriately. However, it does not automatically configure the host to use this configuration. You must do this manually. The location of the config file depends on the installation method used."),(0,i.kt)("p",null,"If RKE2 was installed via RPM, YUM, or DNF (the default on OSes that use RPMs, such as CentOS), run the following commands:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"sudo cp -f /usr/share/rke2/rke2-cis-sysctl.conf /etc/sysctl.d/60-rke2-cis.conf\nsudo systemctl restart systemd-sysctl\n")),(0,i.kt)("p",null,"If RKE2 was installed via the tarball (the default on OSes that do not use RPMs, such as Ubuntu), run the following commands:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"sudo cp -f /usr/local/share/rke2/rke2-cis-sysctl.conf /etc/sysctl.d/60-rke2-cis.conf\nsudo systemctl restart systemd-sysctl\n")),(0,i.kt)("p",null,"If your system lacks the ",(0,i.kt)("inlineCode",{parentName:"p"},"systemd-sysctl.service")," and/or the ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/sysctl.d")," directory, you will want to make sure the sysctls are applied at boot by running the following command during start-up:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"sudo sysctl -p /usr/local/share/rke2/rke2-cis-sysctl.conf\n")),(0,i.kt)("p",null,"Please perform this step only on fresh installations, before actually using RKE2 to deploy Kubernetes. Many Kubernetes components, including CNI plugins, set up their own sysctls. Restarting the ",(0,i.kt)("inlineCode",{parentName:"p"},"systemd-sysctl")," service on a running Kubernetes cluster can result in unexpected side-effects."),(0,i.kt)("h4",{id:"create-the-etcd-user"},"Create the etcd user"),(0,i.kt)("p",null,"On some Linux distributions, the ",(0,i.kt)("inlineCode",{parentName:"p"},"useradd")," command will not create a group. The ",(0,i.kt)("inlineCode",{parentName:"p"},"-U")," flag is included below to account for that. This flag tells ",(0,i.kt)("inlineCode",{parentName:"p"},"useradd")," to create a group with the same name as the user."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'sudo useradd -r -c "etcd user" -s /sbin/nologin -M etcd -U\n')),(0,i.kt)("h2",{id:"kubernetes-runtime-requirements"},"Kubernetes runtime requirements"),(0,i.kt)("p",null,"The runtime requirements to pass the CIS Benchmark are centered around pod security and network policies. These are outlined in this section."),(0,i.kt)("h3",{id:"podsecuritypolicies"},(0,i.kt)("inlineCode",{parentName:"h3"},"PodSecurityPolicies")),(0,i.kt)("p",null,"RKE2 always runs with the ",(0,i.kt)("inlineCode",{parentName:"p"},"PodSecurityPolicy")," admission controller turned on. However, when it is ",(0,i.kt)("strong",{parentName:"p"},"not"),' started with a valid "cis-1.x" profile, RKE2 will put an unrestricted policy in place that allows Kubernetes to run as though the ',(0,i.kt)("inlineCode",{parentName:"p"},"PodSecurityPolicy")," admission controller was not enabled."),(0,i.kt)("p",null,'When ran with a valid "cis-1.x" profile, RKE2 will put a much more restrictive set of policies in place. These policies meet the requirements outlined in section 5.2 of the CIS Benchmark.'),(0,i.kt)("p",null,"!!! note\nThe Kubernetes control plane components and critical additions such as CNI, DNS, and Ingress are ran as pods in the ",(0,i.kt)("inlineCode",{parentName:"p"},"kube-system")," namespace. Therefore, this namespace will have a policy that is less restrictive so that these components can run properly."),(0,i.kt)("h3",{id:"networkpolicies"},(0,i.kt)("inlineCode",{parentName:"h3"},"NetworkPolicies")),(0,i.kt)("p",null,'When ran with a valid "cis-1.x" profile, RKE2 will put ',(0,i.kt)("inlineCode",{parentName:"p"},"NetworkPolicies")," in place that passes the CIS Benchmark for Kubernetes' built-in namespaces. These namespaces are: ",(0,i.kt)("inlineCode",{parentName:"p"},"kube-system"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"kube-public"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"kube-node-lease"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"default"),"."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"NetworkPolicy")," used will only allow pods within the same namespace to talk to each other. The notable exception to this is that it allows DNS requests to be resolved."),(0,i.kt)("p",null,"!!! note\nOperators must manage network policies as normal for additional namespaces that are created."),(0,i.kt)("h3",{id:"configure-default-service-account"},"Configure ",(0,i.kt)("inlineCode",{parentName:"h3"},"default")," service account"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Set ",(0,i.kt)("inlineCode",{parentName:"strong"},"automountServiceAccountToken")," to ",(0,i.kt)("inlineCode",{parentName:"strong"},"false")," for ",(0,i.kt)("inlineCode",{parentName:"strong"},"default")," service accounts")),(0,i.kt)("p",null,"Kubernetes provides a ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," service account which is used by cluster workloads where no specific service account is assigned to the pod. Where access to the Kubernetes API from a pod is required, a specific service account should be created for that pod, and rights granted to that service account. The ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," service account should be configured such that it does not provide a service account token and does not have any explicit rights assignments."),(0,i.kt)("p",null,"For each namespace including ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"kube-system")," on a standard RKE2 install, the ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," service account must include this value:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"automountServiceAccountToken: false\n")),(0,i.kt)("p",null,"For namespaces created by the cluster operator, the following script and configuration file can be used to configure the ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," service account."),(0,i.kt)("p",null,"The configuration below must be saved to a file called ",(0,i.kt)("inlineCode",{parentName:"p"},"account_update.yaml"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: default\nautomountServiceAccountToken: false\n")),(0,i.kt)("p",null,"Create a bash script file called ",(0,i.kt)("inlineCode",{parentName:"p"},"account_update.sh"),". Be sure to ",(0,i.kt)("inlineCode",{parentName:"p"},"sudo chmod +x account_update.sh")," so the script has execute permissions."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash -e\n\nfor namespace in $(kubectl get namespaces -A -o=jsonpath="{.items[*][\'metadata.name\']}"); do\n  echo -n "Patching namespace $namespace - "\n  kubectl patch serviceaccount default -n ${namespace} -p "$(cat account_update.yaml)"\ndone\n')),(0,i.kt)("p",null,"Execute this script to apply the ",(0,i.kt)("inlineCode",{parentName:"p"},"account_update.yaml")," configuration to ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," service account in all namespaces."),(0,i.kt)("h3",{id:"api-server-audit-configuration"},"API Server audit configuration"),(0,i.kt)("p",null,"CIS requirements 1.2.22 to 1.2.25 are related to configuring audit logs for the API Server. When RKE2 is started with the ",(0,i.kt)("inlineCode",{parentName:"p"},"profile")," flag set, it will automatically configure hardened ",(0,i.kt)("inlineCode",{parentName:"p"},"--audit-log-")," parameters in the API Server to pass those CIS checks."),(0,i.kt)("p",null,"RKE2's default audit policy is configured to not log requests in the API Server. This is done to allow cluster operators flexibility to customize an audit policy that suits their auditing requirements and needs, as these are specific to each users' environment and policies."),(0,i.kt)("p",null,"A default audit policy is created by RKE2 when started with the ",(0,i.kt)("inlineCode",{parentName:"p"},"profile")," flag set. The policy is defined in ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/rancher/rke2/audit-policy.yaml"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: audit.k8s.io/v1\nkind: Policy\nmetadata:\n  creationTimestamp: null\nrules:\n- level: None\n")),(0,i.kt)("p",null,"To start logging requests to the API Server, at least ",(0,i.kt)("inlineCode",{parentName:"p"},"level")," parameter must be modified, for example, to ",(0,i.kt)("inlineCode",{parentName:"p"},"Metadata"),". Detailed information about policy configuration for the API server can be found in the Kubernetes ",(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/debug-application-cluster/audit/"},"documentation"),"."),(0,i.kt)("p",null,"After adapting the audit policy, RKE2 must be restarted to load the new configuration."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"sudo systemctl restart rke2-server.service\n")),(0,i.kt)("p",null,"API Server audit logs will be written to ",(0,i.kt)("inlineCode",{parentName:"p"},"/var/lib/rancher/rke2/server/logs/audit.log"),"."),(0,i.kt)("h2",{id:"known-issues"},"Known issues"),(0,i.kt)("p",null,"The following are controls that RKE2 currently does not pass. Each gap will be explained and whether it can be passed through manual operator intervention or if it will be addressed in a future release."),(0,i.kt)("h3",{id:"control--1112"},"Control  1.1.12"),(0,i.kt)("p",null,"Ensure that the etcd data directory ownership is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"etcd:etcd"),"."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Rationale"),"\netcd is a highly-available key-value store used by Kubernetes deployments for persistent storage of all of its REST API objects. This data directory should be protected from any unauthorized reads or writes. It should be owned by ",(0,i.kt)("inlineCode",{parentName:"p"},"etcd:etcd"),"."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Remediation"),"\nThis can be remediated by creating an ",(0,i.kt)("inlineCode",{parentName:"p"},"etcd")," user and group as described above."),(0,i.kt)("h3",{id:"control-515"},"Control 5.1.5"),(0,i.kt)("p",null,"Ensure that default service accounts are not actively used"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Rationale")," Kubernetes provides a ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," service account which is used by cluster workloads where no specific service account is assigned to the pod."),(0,i.kt)("p",null,"Where access to the Kubernetes API from a pod is required, a specific service account should be created for that pod, and rights granted to that service account."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," service account should be configured such that it does not provide a service account token and does not have any explicit rights assignments."),(0,i.kt)("p",null,"This can be remediated by updating the ",(0,i.kt)("inlineCode",{parentName:"p"},"automountServiceAccountToken")," field to ",(0,i.kt)("inlineCode",{parentName:"p"},"false")," for the ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," service account in each namespace."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Remediation"),"\nYou can manually update this field on service accounts in your cluster to pass the control as described above."),(0,i.kt)("h3",{id:"control-532"},"Control 5.3.2"),(0,i.kt)("p",null,"Ensure that all Namespaces have Network Policies defined"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Rationale"),"\nRunning different applications on the same Kubernetes cluster creates a risk of one compromised application attacking a neighboring application. Network segmentation is important to ensure that containers can communicate only with those they are supposed to. A network policy is a specification of how selections of pods are allowed to communicate with each other and other network endpoints."),(0,i.kt)("p",null,"Network Policies are namespace scoped. When a network policy is introduced to a given namespace, all traffic not allowed by the policy is denied. However, if there are no network policies in a namespace all traffic will be allowed into and out of the pods in that namespace."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Remediation"),"\nThis can be remediated by starting RKE2 with the ",(0,i.kt)("inlineCode",{parentName:"p"},"profile")," flag set in the configuration file. An example can be found below."),(0,i.kt)("h2",{id:"rke2-configuration"},"RKE2 configuration"),(0,i.kt)(o.Z,{mdxType:"Tabs"},(0,i.kt)(s.Z,{value:"v1.25 and Newer",default:!0,mdxType:"TabItem"},(0,i.kt)("p",null,"Below is the minimum necessary configuration needed for hardening RKE2 to pass CIS v1.23 hardened profile ",(0,i.kt)("inlineCode",{parentName:"p"},"rke2-cis-1.23-profile-hardened")," available in Rancher."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'secrets-encryption: "true"\nprofile: "cis-1.23"           # CIS 4.2.6, 5.2.1, 5.2.8, 5.2.9, 5.3.2\n'))),(0,i.kt)(s.Z,{value:"v1.24 and Older",mdxType:"TabItem"},(0,i.kt)("p",null,"Below is the minimum necessary configuration needed for hardening RKE2 to pass CIS v1.6 hardened profile ",(0,i.kt)("inlineCode",{parentName:"p"},"rke2-cis-1.6-profile-hardened")," available in Rancher."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'secrets-encryption: "true"\nprofile: "cis-1.6"           # CIS 4.2.6, 5.2.1, 5.2.8, 5.2.9, 5.3.2\n')))),(0,i.kt)("p",null,"The configuration file must be named ",(0,i.kt)("inlineCode",{parentName:"p"},"config.yaml")," and placed in ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/rancher/rke2"),". The directory needs to be created prior to installing RKE2."),(0,i.kt)("h2",{id:"conclusion"},"Conclusion"),(0,i.kt)("p",null,"If you have followed this guide, your RKE2 cluster will be configured to pass the CIS Kubernetes Benchmark. You can review our CIS Benchmark Self-Assessment Guide ",(0,i.kt)("a",{parentName:"p",href:"/security/cis_self_assessment16"},"v1.6")," or ",(0,i.kt)("a",{parentName:"p",href:"/security/cis_self_assessment123"},"v1.23")," to understand how we verified each of the benchmarks and how you can do the same on your cluster."))}f.isMDXComponent=!0}}]);